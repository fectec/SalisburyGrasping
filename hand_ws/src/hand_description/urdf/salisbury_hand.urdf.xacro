<?xml version="1.0"?>
<robot name="salisbury_hand" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- Kinematic parameters -->
  <xacro:property name="a1" value="0.1" />
  <xacro:property name="a2" value="0.1" />
  <xacro:property name="a3" value="0.05" />
  <xacro:property name="tip_offset" value="0.02" />

  <!-- Finger base positions -->
  <xacro:property name="finger1_base" value="0.05 0 -0.05" />
  <xacro:property name="finger2_base" value="0.05 -0.05 0.05" />
  <xacro:property name="finger3_base" value="0.05 0.05 0.05" />

  <!-- The root link -->
  <link name="world"/>

  <!-- Macro to create a finger chain with custom parameters -->
  <xacro:macro name="finger" params="finger_id base_xyz invert theta_lower_joint0 theta_upper_joint0">
    
    <!-- Fixed transform from world to finger base -->
    <link name="finger${finger_id}_base_link"/>
    <joint name="finger${finger_id}_base_fixed" type="fixed">
      <parent link="world"/>
      <child link="finger${finger_id}_base_link"/>
      <origin xyz="${base_xyz}" rpy="${ '3.14159265359 -0.7854 0' if invert else '0 0.7854 0'}"/>
    </joint>

    <!-- Joint 0 (revolute) with custom theta constraints -->
    <link name="finger${finger_id}_joint0_link"/>
    <joint name="finger${finger_id}_joint0" type="revolute">
      <parent link="finger${finger_id}_base_link"/>
      <child link="finger${finger_id}_joint0_link"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="${theta_lower_joint0}" upper="${theta_upper_joint0}" effort="10" velocity="1"/>
    </joint>

    <!-- Link 0 -->
    <link name="finger${finger_id}_link0"/>
    <joint name="finger${finger_id}_link0_fixed" type="fixed">
      <parent link="finger${finger_id}_joint0_link"/>
      <child link="finger${finger_id}_link0"/>
      <origin xyz="${a1} 0 0" rpy="-1.5708 0 0"/>
    </joint>

    <!-- Joint 1 -->
    <link name="finger${finger_id}_joint1_link"/>
    <joint name="finger${finger_id}_joint1" type="revolute">
      <parent link="finger${finger_id}_link0"/>
      <child link="finger${finger_id}_joint1_link"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="-0.7854" upper="-1.5708" effort="10" velocity="1"/>
    </joint>

    <!-- Link 1 -->
    <link name="finger${finger_id}_link1"/>
    <joint name="finger${finger_id}_link1_fixed" type="fixed">
      <parent link="finger${finger_id}_joint1_link"/>
      <child link="finger${finger_id}_link1"/>
      <origin xyz="${a2} 0 0" rpy="0 0 0"/>
    </joint>

    <!-- Joint 2 -->
    <link name="finger${finger_id}_joint2_link"/>
    <joint name="finger${finger_id}_joint2" type="revolute">
      <parent link="finger${finger_id}_link1"/>
      <child link="finger${finger_id}_joint2_link"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="-0.19635" upper="-0.7854" effort="10" velocity="1"/>
    </joint>

    <!-- Link 2 -->
    <link name="finger${finger_id}_link2"/>
    <joint name="finger${finger_id}_link2_fixed" type="fixed">
      <parent link="finger${finger_id}_joint2_link"/>
      <child link="finger${finger_id}_link2"/>
      <origin xyz="${a3} 0 0" rpy="0 0 0"/>
    </joint>

    <!-- End Effector / Fingertip -->
    <link name="finger${finger_id}_tip"/>
    <joint name="finger${finger_id}_tip_fixed" type="fixed">
      <parent link="finger${finger_id}_link2"/>
      <child link="finger${finger_id}_tip"/>
      <origin xyz="${tip_offset} 0 0" rpy="0 0 0"/>
    </joint>

  </xacro:macro>

  <!-- Instantiate fingers with custom parameters -->
  <xacro:finger finger_id="1" base_xyz="${finger1_base}" invert="false" theta_lower_joint0="-0.3927" theta_upper_joint0="0.3927"/>
  <xacro:finger finger_id="2" base_xyz="${finger2_base}" invert="true"  theta_lower_joint0="-0.3927"    theta_upper_joint0="0.3927"/>
  <xacro:finger finger_id="3" base_xyz="${finger3_base}" invert="true"  theta_lower_joint0="-0.3927"    theta_upper_joint0="0.3927"/>

</robot>